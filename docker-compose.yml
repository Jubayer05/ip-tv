services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${NEXT_PUBLIC_FIREBASE_APP_ID}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
    ports:
      - "3000:3000"
    # Load environment variables from .env.local file
    env_file:
      - .env.local
    # Also explicitly set critical ones (as backup)
    environment:
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB=${MONGODB_DB}
      - JWT_SECRET=${JWT_SECRET}
      - VPNAPI_KEY=${VPNAPI_KEY}
      - GOOGLE_TRANSLATE_API_KEY=${GOOGLE_TRANSLATE_API_KEY}
      - MEGAOTT_KEY=${MEGAOTT_KEY}
      - SUPER_ADMIN_EMAILS=${SUPER_ADMIN_EMAILS}  # Add this line
      # Upload directory configuration (Docker path)
      - UPLOAD_DIR=/app/public/uploads
      # Performance optimizations
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=6144
      # Enable MongoDB debugging
      - DEBUG_MONGODB=true
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # DNS configuration for faster MongoDB Atlas resolution
    dns:
      - 8.8.8.8 # Google DNS
      - 8.8.4.4 # Google DNS backup
      - 1.1.1.1 # Cloudflare DNS
    # Network optimizations
    network_mode: bridge
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "4"
          memory: 8G
        reservations:
          cpus: "1"
          memory: 2G
    volumes:
      - ./public/uploads:/app/public/uploads
    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Extra hosts for MongoDB Atlas (if needed)
    extra_hosts:
      - "host.docker.internal:host-gateway"
